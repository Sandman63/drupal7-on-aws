FROM drupal:7-apache

# Add some extra packages we need in this file
RUN apt-get update && apt-get install -y unzip \
  && rm -rf /var/lib/apt/lists/*

# Create the sites/default/files folder so Drupal can write caches to it
RUN mkdir -p sites/default/files \
  && chown www-data:www-data sites/default/files

# Add pecl memcache module
RUN apt-get update && apt-get install -y libmemcached-dev \
  && pecl install memcached \
  && docker-php-ext-enable memcached

# Copy our local settings.php file into the container.
# This file is generated by the AWS CF LaunchConfiguration during the stack
# creation. An example file is provided here.
COPY settings.php sites/default/settings.php

# Add memcached contrib module
RUN mkdir -p sites/all/modules/contrib/memcache \
  && curl -Lks https://ftp.drupal.org/files/projects/memcache-7.x-1.5.tar.gz \
  | tar --strip=1 -xzC sites/all/modules/contrib/memcache

# Add Libraries contrib module
RUN mkdir -p sites/all/modules/contrib/libraries \
  && curl -Lks https://ftp.drupal.org/files/projects/libraries-7.x-2.3.tar.gz \
  | tar --strip=1 -xzC sites/all/modules/contrib/libraries

# Add awssdk2 library, needed for s3fs
ENV AWSSDK_MD5 fe0596207f39affa2ba2ee83a7db1064
RUN curl -Lks https://github.com/aws/aws-sdk-php/releases/download/2.7.25/aws.zip -o /tmp/aws.zip \
  && echo "${AWSSDK_MD5} /tmp/aws.zip" | md5sum -c - \
  && unzip /tmp/aws.zip -d sites/all/libraries/awssdk2/ \
  && rm -f /tmp/aws.zip

# Add S3fs contrib module
RUN mkdir -p sites/all/modules/contrib/s3fs \
  && curl -Lks https://ftp.drupal.org/files/projects/s3fs-7.x-2.5.tar.gz \
  | tar --strip=1 -xzC sites/all/modules/contrib/s3fs
